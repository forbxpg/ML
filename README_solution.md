# Лабораторная работа: Итеративно взвешенные наименьшие квадраты (IRLS)

## Техническое задание

Реализация метода итеративно взвешенных наименьших квадратов для построения робастной линейной регрессии с учетом выбросов в данных.

### Задания

1. **Построить простейшую линейную регрессионную модель, используя метод OLS**
   - Рассчитать коэффициенты детерминации на обучающей и тестовой выборках
   - На диаграмме рассеяния вывести рассчитанную функцию регрессии

2. **Рассчитать стандартизованные остатки и робастные стандартизованные остатки**
   - Визуализировать в виде диаграмм рассеяния и гистограмм
   - Сравнить полученные выборки
   - Проверить распределения остатков на нормальность (гистограммы и Q-Q диаграммы)

3. **Рассчитать биквадратные веса наблюдений**
   - Отметить на диаграмме рассеяния наблюдения с наибольшими и наименьшими весами
   - Построить WLS модель с рассчитанными весами

4. **Повторить пп. 2-3 до сходимости модели**
   - Сравнить параметры финальной модели с исходной OLS моделью
   - Сравнить функции регрессии и коэффициенты детерминации

5. **Анализ остатков IRLS-модели и идентификация выбросов**
   - Построить графики зависимости остатков от входной переменной
   - Идентифицировать выбросы по критерию: робастный стандартизованный остаток > робастное с.к.о.

6. **Сравнение методов OLS и IRLS**

## План выполнения

### Этап 1: Анализ существующего кода ✅
**Проблемы в исходном коде:**
- Отсутствует линия регрессии на графике рассеяния (задание 1)
- Опечатка в названии переменной `robust_str_residuals_test` вместо `robust_std_residuals_test`
- Графики сохраняются в файлы вместо отображения в Jupyter
- Отсутствует реализация заданий 3-6

### Этап 2: Создание полного решения ✅
Создан файл `solution.py` с полной реализацией всех заданий:

#### Задание 1: OLS модель
```python
def task_1_ols_model(X_train, X_test, y_train, y_test):
    # Обучение OLS модели с константой
    # Расчет R² на обеих выборках
    # Визуализация с линией регрессии
```

#### Задание 2: Анализ остатков OLS
```python
def task_2_residuals_analysis(ols_model, X_train, X_test, y_train, y_test, ols_pred_test):
    # Расчет стандартизованных остатков
    # Расчет робастных стандартизованных остатков (MAD-based)
    # Визуализация: scatter plots и гистограммы с Q-Q plots
```

#### Задание 3: Биквадратные веса и WLS модель
```python
def calculate_bisquare_weights(residuals, scale):
    # Формула: w_i = (1 - (r_i / (6 * scale))^2)^2 для |r_i| < 6*scale
    # w_i = 0 для |r_i| >= 6*scale

def task_3_wls_model(X_train, X_test, y_train, y_test, residuals_train, scale_train):
    # Расчет биквадратных весов
    # Обучение WLS модели
    # Визуализация с выделением выбросов
```

#### Задание 4: Итеративный процесс IRLS
```python
def task_4_irls_process(X_train, X_test, y_train, y_test):
    # Цикл итераций до сходимости
    # Критерий сходимости: изменение коэффициентов < tolerance
    # Визуализация процесса сходимости
```

#### Задание 5: Анализ выбросов в IRLS-модели
```python
def task_5_outlier_analysis(final_model, X_train, y_train):
    # Расчет остатков финальной модели
    # Идентификация выбросов по критерию
    # Визуализация результатов
```

#### Задание 6: Сравнение методов
```python
def task_6_comparison(ols_model, final_model, ...):
    # Сравнение коэффициентов и R²
    # Определение лучшего метода
    # Выводы и рекомендации
```

## Ключевые особенности реализации

### Робастные оценки
- **MAD (Median Absolute Deviation)**: `MAD = median(|r_i - median(r)|)`
- **Масштаб**: `scale = MAD / 0.6745` (для нормального распределения)
- **Стандартизованные остатки**: `r_i / scale`

### Биквадратные веса
```python
def calculate_bisquare_weights(residuals, scale):
    standardized_residuals = residuals / (6 * scale)
    weights = np.where(
        np.abs(standardized_residuals) < 1,
        (1 - standardized_residuals**2)**2,
        0
    )
    return weights
```

### Критерий сходимости IRLS
- Максимальное изменение коэффициентов между итерациями < `1e-6`
- Максимум 100 итераций

### Критерий идентификации выбросов
- Наблюдение является выбросом, если `|робастный стандартизованный остаток| > робастное с.к.о. остатков`

## Запуск решения

```bash
cd /Users/forbxpg/Desktop/logistic-regression-ml
python solution.py
```

## Структура проекта

```
/Users/forbxpg/Desktop/logistic-regression-ml/
├── solution.py           # Полное решение всех заданий
├── task.ipynb            # Исходный ноутбук (требует доработки)
├── data_v1-08.csv        # Данные для анализа
├── requirements/
│   ├── tasks.md          # Техническое задание
│   └── tasks_ml_lab1_2025.docx
└── README_solution.md    # Это файл
```

## Результаты выполнения

При запуске `solution.py` программа выполнит все задания последовательно и выведет:

1. **Результаты OLS модели** с визуализацией
2. **Анализ остатков OLS** с графиками нормальности
3. **WLS модель с биквадратными весами** и выделением выбросов
4. **Процесс IRLS** с визуализацией сходимости
5. **Анализ выбросов** в финальной модели
6. **Сравнение методов** с выводами

Все графики отображаются интерактивно с подробными подписями и легендами.

## Выводы

Метод IRLS демонстрирует лучшую робастность по сравнению с OLS при наличии выбросов в данных. Финальная модель после итеративного процесса показывает более стабильные результаты и лучшую обобщающую способность на тестовой выборке.
